<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é˜¿ç“¦éš†æ¸¸æˆ</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'ZCOOL KuaiLe', sans-serif;
      background: linear-gradient(160deg, #f8f6f2, #ede9e4);
      color: hsl(30,15%,25%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    h1 {
      text-align: center;
      padding: 20px 10px 5px;
      margin: 0;
      font-size: clamp(24px, 5vw, 38px);
      letter-spacing: 2px;
      color: hsl(35,30%,60%);
      text-shadow: 0 0 8px rgba(180,160,120,0.2);
    }
    .signature {
      text-align: center;
      font-size: 14px;
      margin-top: -5px;
      margin-bottom: 10px;
      letter-spacing: 1px;
      font-weight: bold;
      background: linear-gradient(90deg, #bfa27f, #d8c690, #bfa27f);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shine 6s linear infinite;
    }
    @keyframes shine {
      0% { background-position: 0% center; }
      100% { background-position: 200% center; }
    }
    .card {
      background: rgba(255, 255, 255, 0.7);
      border-radius: 16px;
      padding: 20px;
      width: 90%;
      max-width: 480px;
      margin: 15px auto;
      backdrop-filter: blur(20px) saturate(160%);
      -webkit-backdrop-filter: blur(20px) saturate(160%);
      border: 1px solid rgba(180,160,120,0.25);
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      animation: fadeIn 0.5s ease;
      box-sizing: border-box;
    }
    input {
      margin: 10px 0;
      padding: 12px;
      width: 100%;
      border: 1px solid rgba(180,160,120,0.4);
      border-radius: 10px;
      font-size: 16px;
      background: rgba(255,255,255,0.85);
      color: hsl(30,15%,25%);
      box-sizing: border-box;
    }
    input::placeholder { color: #8e8e93; }
    button {
      margin-top: 10px;
      padding: 12px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      font-weight: bold;
      letter-spacing: 1px;
      transition: all 0.3s;
      font-family: 'ZCOOL KuaiLe', sans-serif;
      box-sizing: border-box;
    }
    button:hover { transform: scale(1.03); }

    .btn-primary { 
      background: linear-gradient(90deg, hsl(35,30%,60%), hsl(35,25%,50%)); 
      color: #fff; 
      box-shadow: 0 0 8px rgba(180,160,120,0.3);
    }
    .btn-secondary { 
      background: linear-gradient(90deg, hsl(135,25%,55%), hsl(135,20%,45%));
      color: #fff;
    }
    .btn-danger { 
      background: linear-gradient(90deg, hsl(3,40%,55%), hsl(3,35%,45%)); 
      color: #fff; 
    }

    #stepCreate, #stepJoin, #stepRoomList, #room, #stepChangeName { display:none; }

    #playerList { list-style:none; padding:0; margin:10px 0; }
    #playerList li {
      background: rgba(255,255,255,0.75);
      margin: 6px 0;
      padding: 10px;
      border-radius: 8px;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transition: transform 0.2s;
    }
    #playerList li:hover { transform: scale(1.01); }
    #playerList li.me { border: 2px solid hsl(35,30%,60%); }
    .kickBtn {
      margin-left: 8px;
      padding: 4px 6px;
      border-radius: 6px;
      font-size: 12px;
      background: hsl(3,40%,55%);
      color: #fff;
      border: none;
      cursor: pointer;
    }

    #myRole {
      margin-top: 16px;
      padding: 14px;
      border-radius: 12px;
      font-size: 16px;
      background: rgba(180,160,120,0.1);
      color: hsl(35,30%,60%);
      box-shadow: inset 0 0 8px rgba(180,160,120,0.25);
      white-space: pre-line;
    }

    #message {
      margin-top: 10px;
      font-size: 14px;
      text-align: center;
    }

    @keyframes fadeIn {
      from { opacity:0; transform: translateY(10px); }
      to { opacity:1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <h1>é˜¿ç“¦éš†æ¸¸æˆ</h1>
  <div class="signature">@ç”± Chace åˆ¶ä½œ</div>

  <div id="step1" class="card">
    <button class="btn-primary" onclick="goCreate()">åˆ›å»ºæˆ¿é—´</button>
    <button class="btn-secondary" onclick="goJoin()">åŠ å…¥æˆ¿é—´</button>
  </div>

  <div id="stepCreate" class="card">
    <h3>åˆ›å»ºæˆ¿é—´</h3>
    <input id="hostName" placeholder="è¾“å…¥ä½ çš„æ˜µç§°">
    <button class="btn-primary" onclick="createRoom()">ç¡®è®¤åˆ›å»º</button>
    <button class="btn-danger" onclick="goBack()">è¿”å›</button>
  </div>

  <!-- æˆ¿é—´åˆ—è¡¨ -->
  <div id="stepRoomList" class="card">
    <h3>é€‰æ‹©æˆ¿é—´</h3>
    <ul id="roomList"></ul>
    <button class="btn-danger" onclick="goBack()">è¿”å›</button>
  </div>

  <div id="room" class="card">
    <h2>æˆ¿é—´å·ï¼š<span id="roomCodeDisplay"></span></h2>
    <div id="roomCount" style="margin-bottom:10px;font-size:14px;color:#555;">å½“å‰äººæ•°ï¼š0 äºº</div>
    <h3>ç©å®¶åˆ—è¡¨</h3>
    <ul id="playerList"></ul>

    <button class="btn-primary" onclick="goChangeName()">ä¿®æ”¹æ˜µç§°</button>
    <button class="btn-secondary" onclick="assignRoles()">åˆ†é…èº«ä»½ï¼ˆä»…æˆ¿ä¸»ï¼‰</button>
    <button class="btn-danger" onclick="leaveRoom()">é€€å‡ºæˆ¿é—´</button>

    <div id="myRole">æˆ‘çš„èº«ä»½ï¼šæœªåˆ†é…</div>
    <div id="message"></div>
  </div>

  <div id="stepChangeName" class="card">
    <h3>ä¿®æ”¹æ˜µç§°</h3>
    <input id="newNameInput" placeholder="è¾“å…¥æ–°æ˜µç§°">
    <button class="btn-primary" onclick="changeName()">ç¡®è®¤ä¿®æ”¹</button>
    <button class="btn-danger" onclick="backToRoom()">è¿”å›æˆ¿é—´</button>
  </div>

  <script>
    const supabaseUrl = "https://haphpamjhptydpqiroyx.supabase.co";  
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhhcGhwYW1qaHB0eWRwcWlyb3l4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxOTEzNzYsImV4cCI6MjA3MTc2NzM3Nn0.xwncUm2EdIUOeD2OQOrqOEaD9EZW4ZSpRT5apHO3ZT8";  
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let currentRoom = null;
    let myName = null;
    let isHost = false;

    function goCreate(){ show("stepCreate"); }
    function goJoin(){ 
      show("stepRoomList"); 
      loadRoomList();
      supabase.channel("rooms-list")
        .on("postgres_changes",{event:"*",schema:"public",table:"avalon_rooms"},()=>loadRoomList())
        .subscribe();
    }
    function goBack(){ show("step1"); }
    function goChangeName(){ show("stepChangeName"); }
    function backToRoom(){ show("room"); }
    function show(id){
      ["step1","stepCreate","stepRoomList","room","stepChangeName"].forEach(s=>document.getElementById(s).style.display="none");
      document.getElementById(id).style.display="block";
    }

    function switchToRoom(roomCode){
      show("room");
      document.getElementById("roomCodeDisplay").innerText = roomCode;
    }

    function showMessage(text, color="hsl(135,25%,45%)"){
      const msg = document.getElementById("message");
      msg.innerText = text;
      msg.style.color = color;
      setTimeout(()=>{ msg.innerText=""; }, 3000);
    }

    async function getNextRoomCode(){
      const { data } = await supabase
        .from("avalon_rooms")
        .select("room_code")
        .order("room_code",{ascending:false})
        .limit(1);
      if(data && data.length>0){
        let last = parseInt(data[0].room_code,10);
        return String(last+1).padStart(3,"0");
      }else{
        return "001";
      }
    }

    async function createRoom(){
      myName = document.getElementById("hostName").value.trim();
      if(!myName){ showMessage("è¯·è¾“å…¥æ˜µç§°","hsl(3,40%,55%)"); return; }

      const roomCode = await getNextRoomCode();
      currentRoom = roomCode;
      isHost = true;

      const { error } = await supabase.from("avalon_rooms").insert([{
        room_code: roomCode,
        player_name: myName,
        role: null,
        is_host: true
      }]);
      if(error){ showMessage("åˆ›å»ºå¤±è´¥: "+error.message,"hsl(3,40%,55%)"); return; }

      switchToRoom(roomCode);
      listenRoom(roomCode);
      showMessage("æˆ¿é—´åˆ›å»ºæˆåŠŸï¼");
    }

    async function loadRoomList(){
      const { data, error } = await supabase
        .from("avalon_rooms")
        .select("room_code, is_host")
        .order("room_code",{ascending:true});

      const list = document.getElementById("roomList");
      list.innerHTML = "";

      if(error){
        list.innerHTML = "<li>åŠ è½½å¤±è´¥ï¼š"+error.message+"</li>";
        return;
      }
      if(!data || data.length===0){
        list.innerHTML = "<li>æš‚æ— æˆ¿é—´</li>";
        return;
      }

      const roomMap = {};
      data.forEach(r=>{
        if(!roomMap[r.room_code]) roomMap[r.room_code] = { count:0, hasHost:false };
        roomMap[r.room_code].count++;
        if(r.is_host) roomMap[r.room_code].hasHost = true;
      });

      Object.entries(roomMap).forEach(([code, info])=>{
        if(!info.hasHost) return;
        const li = document.createElement("li");
        li.style.margin = "8px 0";
        li.innerHTML = `
          <b>æˆ¿é—´ ${code}</b> (${info.count}äºº)
          <button class="btn-secondary" style="width:auto;padding:6px 10px;font-size:14px;margin-left:10px;" onclick="promptJoin('${code}')">åŠ å…¥</button>
        `;
        list.appendChild(li);
      });

      if(list.innerHTML==="") list.innerHTML="<li>æš‚æ— å¯åŠ å…¥çš„æˆ¿é—´</li>";
    }

    function promptJoin(code){
      const nickname = prompt("è¯·è¾“å…¥ä½ çš„æ˜µç§°ï¼š");
      if(!nickname) return;
      joinRoomByCode(code, nickname);
    }

    async function joinRoomByCode(code, nickname){
      currentRoom = code;
      myName = nickname;

      const { data: check, error: checkError } = await supabase
        .from("avalon_rooms")
        .select("id, player_name, is_host")
        .eq("room_code", currentRoom);

      if(checkError){
        showMessage("åŠ å…¥å¤±è´¥: "+checkError.message,"hsl(3,40%,55%)");
        return;
      }
      if(!check || check.length===0){
        showMessage("æˆ¿é—´ä¸å­˜åœ¨","hsl(3,40%,55%)");
        return;
      }
      if(!check.some(p => p.is_host)){
        showMessage("æˆ¿é—´æ— æ•ˆï¼šæœªæ‰¾åˆ°æˆ¿ä¸»","hsl(3,40%,55%)");
        return;
      }
      if(check.some(p => p.player_name === myName)){
        showMessage("è¯¥æ˜µç§°å·²åœ¨æˆ¿é—´ä¸­","hsl(3,40%,55%)");
        return;
      }

      const { error } = await supabase.from("avalon_rooms").insert([{
        room_code: currentRoom,
        player_name: myName,
        role: null,
        is_host: false
      }]);
      if(error){ 
        showMessage("åŠ å…¥å¤±è´¥: "+error.message,"hsl(3,40%,55%)"); 
        return; 
      }

      isHost = false;
      switchToRoom(currentRoom);
      listenRoom(currentRoom);
      showMessage("åŠ å…¥æˆ¿é—´æˆåŠŸï¼");
    }

    async function leaveRoom(){
      if(isHost){
        await supabase.from("avalon_rooms").delete().eq("room_code", currentRoom);
        showMessage("æˆ¿é—´å·²è§£æ•£ï¼");
      }else{
        await supabase.from("avalon_rooms").delete()
          .eq("room_code", currentRoom)
          .eq("player_name", myName);
        showMessage("å·²é€€å‡ºæˆ¿é—´ï¼");
      }
      currentRoom=null; myName=null; isHost=false;
      show("step1");
      document.getElementById("playerList").innerHTML="";
      document.getElementById("myRole").innerText="æˆ‘çš„èº«ä»½ï¼šæœªåˆ†é…";
    }

    function listenRoom(roomCode){
      supabase.channel("room-"+roomCode)
        .on("postgres_changes",{event:"*",schema:"public",table:"avalon_rooms"},()=>refreshPlayers(roomCode))
        .subscribe();
      refreshPlayers(roomCode);
    }

    function getRoleInfo(myRole, allPlayers){
      let info = [];
      if(myRole === "æ¢…æ—"){
        info = allPlayers.filter(p => ["åˆºå®¢","è«ç”˜å¨œ","çˆªç‰™","å¥¥ä¼¯ä¼¦"].includes(p.role)).map(p=>p.player_name);
      }
      else if(myRole === "æ´¾è¥¿ç»´å°”"){
        info = allPlayers.filter(p => ["æ¢…æ—","è«ç”˜å¨œ"].includes(p.role)).map(p=>p.player_name);
      }
      else if(["åˆºå®¢","è«ç”˜å¨œ","çˆªç‰™","è«å¾·é›·å¾·"].includes(myRole)){
        info = allPlayers.filter(p => ["åˆºå®¢","è«ç”˜å¨œ","çˆªç‰™","è«å¾·é›·å¾·"].includes(p.role)).map(p=>p.player_name);
      }
      else if(myRole === "é‡æ€§ä»™å­"){
        info = allPlayers.filter(p => ["æ´¾è¥¿ç»´å°”","å¥¥ä¼¯ä¼¦","åˆºå®¢"].includes(p.role)).map(p=>p.player_name);
      }
      else if(myRole === "å¥¥ä¼¯ä¼¦" || myRole === "å­¦å¾’"){
        info = [];
      }
      return info;
    }

    async function refreshPlayers(roomCode){
      const { data } = await supabase.from("avalon_rooms").select("id, player_name, role, is_host").eq("room_code", roomCode);
      const list=document.getElementById("playerList"); list.innerHTML="";
      if(data) data.forEach(p=>{
        const li=document.createElement("li");
        li.innerText = p.player_name + (p.is_host ? " ğŸ‘‘æˆ¿ä¸»" : "");
        if(p.player_name===myName) li.classList.add("me");

        if(isHost && !p.is_host){
          const kickBtn = document.createElement("button");
          kickBtn.innerText = "âŒ";
          kickBtn.className = "kickBtn";
          kickBtn.onclick = async () => {
            await supabase.from("avalon_rooms").delete().eq("id", p.id);
            showMessage("å·²è¸¢å‡ºç©å®¶ï¼š"+p.player_name);
          };
          li.appendChild(kickBtn);
        }

        list.appendChild(li);

        if(p.player_name===myName && p.role){
          let text = "æˆ‘çš„èº«ä»½ï¼š" + p.role;
          const info = getRoleInfo(p.role, data);
          if(info.length > 0){
            text += "\næˆ‘èƒ½çœ‹åˆ°ï¼š" + info.join("ã€");
          }
          document.getElementById("myRole").innerText = text;
        }
      });
      document.getElementById("roomCount").innerText = "å½“å‰äººæ•°ï¼š" + (data?data.length:0) + " äºº";
    }

    async function assignRoles(){
      if(!isHost){ showMessage("åªæœ‰æˆ¿ä¸»å¯ä»¥åˆ†é…èº«ä»½","hsl(3,40%,55%)"); return; }
      const { data: players } = await supabase.from("avalon_rooms").select("*").eq("room_code", currentRoom);
      if(!players||players.length===0){ showMessage("æ²¡æœ‰ç©å®¶","hsl(3,40%,55%)"); return; }

      let rolesPool = [];
      if(players.length === 12){
        rolesPool = ["æ¢…æ—","æ´¾è¥¿ç»´å°”","åˆºå®¢","è«ç”˜å¨œ","å¥¥ä¼¯ä¼¦","å¿ è‡£","å¿ è‡£","çˆªç‰™","è«å¾·é›·å¾·","é‡æ€§ä»™å­","å­¦å¾’"];
      } 
      else if(players.length === 11){
        rolesPool = ["æ¢…æ—","æ´¾è¥¿ç»´å°”","åˆºå®¢","è«ç”˜å¨œ","å¥¥ä¼¯ä¼¦","å¿ è‡£","å¿ è‡£","çˆªç‰™","è«å¾·é›·å¾·","é‡æ€§ä»™å­"];
      } 
      else {
        rolesPool = ["æ¢…æ—","æ´¾è¥¿ç»´å°”","åˆºå®¢","è«ç”˜å¨œ","å¥¥ä¼¯ä¼¦","å¿ è‡£","å¿ è‡£","çˆªç‰™"];
      }

      let shuffled = rolesPool.slice(0,players.length).sort(()=>Math.random()-0.5);
      for(let i=0;i<players.length;i++){
        await supabase.from("avalon_rooms").update({role:shuffled[i]}).eq("id",players[i].id);
      }
      showMessage("èº«ä»½åˆ†é…å®Œæˆï¼");
    }

    async function changeName(){
      const newName = document.getElementById("newNameInput").value.trim();
      if(!newName){ showMessage("è¯·è¾“å…¥æ–°æ˜µç§°","hsl(3,40%,55%)"); return; }

      const { error } = await supabase
        .from("avalon_rooms")
        .update({ player_name: newName })
        .eq("room_code", currentRoom)
        .eq("player_name", myName);

      if(error){
        showMessage("ä¿®æ”¹å¤±è´¥: "+error.message,"hsl(3,40%,55%)");
        return;
      }

      myName = newName;
      document.getElementById("newNameInput").value = "";
      refreshPlayers(currentRoom);
      show("room");
      showMessage("æ˜µç§°ä¿®æ”¹æˆåŠŸï¼");
    }
  </script>
</body>
</html>
