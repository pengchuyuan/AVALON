<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>阿瓦隆游戏</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'ZCOOL KuaiLe', sans-serif;
      background: linear-gradient(160deg, #f8f6f2, #ede9e4);
      color: hsl(30,15%,25%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    h1 {
      text-align: center;
      padding: 20px 10px 5px;
      margin: 0;
      font-size: clamp(24px, 5vw, 38px);
      letter-spacing: 2px;
      color: hsl(35,30%,60%);
      text-shadow: 0 0 8px rgba(180,160,120,0.2);
    }
    .signature {
      text-align: center;
      font-size: 14px;
      margin-top: -5px;
      margin-bottom: 10px;
      letter-spacing: 1px;
      font-weight: bold;
      background: linear-gradient(90deg, #bfa27f, #d8c690, #bfa27f);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shine 6s linear infinite;
    }
    @keyframes shine {
      0% { background-position: 0% center; }
      100% { background-position: 200% center; }
    }
    .card {
      background: rgba(255, 255, 255, 0.7);
      border-radius: 16px;
      padding: 20px;
      width: 90%;
      max-width: 480px;
      margin: 15px auto;
      backdrop-filter: blur(20px) saturate(160%);
      -webkit-backdrop-filter: blur(20px) saturate(160%);
      border: 1px solid rgba(180,160,120,0.25);
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      animation: fadeIn 0.5s ease;
      box-sizing: border-box;
    }
    input {
      margin: 10px 0;
      padding: 12px;
      width: 100%;
      border: 1px solid rgba(180,160,120,0.4);
      border-radius: 10px;
      font-size: 16px;
      background: rgba(255,255,255,0.85);
      color: hsl(30,15%,25%);
      box-sizing: border-box;
    }
    input::placeholder { color: #8e8e93; }
    button {
      margin-top: 10px;
      padding: 12px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      font-weight: bold;
      letter-spacing: 1px;
      transition: all 0.3s;
      font-family: 'ZCOOL KuaiLe', sans-serif;
      box-sizing: border-box;
    }
    button:hover { transform: scale(1.03); }

    .btn-primary { 
      background: linear-gradient(90deg, hsl(35,30%,60%), hsl(35,25%,50%)); 
      color: #fff; 
      box-shadow: 0 0 8px rgba(180,160,120,0.3);
    }
    .btn-secondary { 
      background: linear-gradient(90deg, hsl(135,25%,55%), hsl(135,20%,45%));
      color: #fff;
    }
    .btn-danger { 
      background: linear-gradient(90deg, hsl(3,40%,55%), hsl(3,35%,45%)); 
      color: #fff; 
    }

    #stepCreate, #stepJoin, #stepRoomList, #room, #stepChangeName { display:none; }

    #playerList { list-style:none; padding:0; margin:10px 0; }
    #playerList li {
      background: rgba(255,255,255,0.75);
      margin: 6px 0;
      padding: 10px;
      border-radius: 8px;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transition: transform 0.2s;
    }
    #playerList li:hover { transform: scale(1.01); }
    #playerList li.me { border: 2px solid hsl(35,30%,60%); }
    .kickBtn {
      margin-left: 8px;
      padding: 4px 6px;
      border-radius: 6px;
      font-size: 12px;
      background: hsl(3,40%,55%);
      color: #fff;
      border: none;
      cursor: pointer;
    }

    #myRole {
      margin-top: 16px;
      padding: 14px;
      border-radius: 12px;
      font-size: 16px;
      background: rgba(180,160,120,0.1);
      color: hsl(35,30%,60%);
      box-shadow: inset 0 0 8px rgba(180,160,120,0.25);
      white-space: pre-line;
    }

    #message {
      margin-top: 10px;
      font-size: 14px;
      text-align: center;
    }

    @keyframes fadeIn {
      from { opacity:0; transform: translateY(10px); }
      to { opacity:1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <h1>阿瓦隆游戏</h1>
  <div class="signature">@由 Chace 制作</div>

  <div id="step1" class="card">
    <button class="btn-primary" onclick="goCreate()">创建房间</button>
    <button class="btn-secondary" onclick="goJoin()">加入房间</button>
  </div>

  <div id="stepCreate" class="card">
    <h3>创建房间</h3>
    <input id="hostName" placeholder="输入你的昵称">
    <button class="btn-primary" onclick="createRoom()">确认创建</button>
    <button class="btn-danger" onclick="goBack()">返回</button>
  </div>

  <!-- 房间列表 -->
  <div id="stepRoomList" class="card">
    <h3>选择房间</h3>
    <ul id="roomList"></ul>
    <button class="btn-danger" onclick="goBack()">返回</button>
  </div>

  <div id="room" class="card">
    <h2>房间号：<span id="roomCodeDisplay"></span></h2>
    <div id="roomCount" style="margin-bottom:10px;font-size:14px;color:#555;">当前人数：0 人</div>
    <h3>玩家列表</h3>
    <ul id="playerList"></ul>

    <button class="btn-primary" onclick="goChangeName()">修改昵称</button>
    <button class="btn-secondary" onclick="assignRoles()">分配身份（仅房主）</button>
    <button class="btn-danger" onclick="leaveRoom()">退出房间</button>

    <div id="myRole">我的身份：未分配</div>
    <div id="message"></div>
  </div>

  <div id="stepChangeName" class="card">
    <h3>修改昵称</h3>
    <input id="newNameInput" placeholder="输入新昵称">
    <button class="btn-primary" onclick="changeName()">确认修改</button>
    <button class="btn-danger" onclick="backToRoom()">返回房间</button>
  </div>

  <script>
    const supabaseUrl = "https://haphpamjhptydpqiroyx.supabase.co";  
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhhcGhwYW1qaHB0eWRwcWlyb3l4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxOTEzNzYsImV4cCI6MjA3MTc2NzM3Nn0.xwncUm2EdIUOeD2OQOrqOEaD9EZW4ZSpRT5apHO3ZT8";  
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let currentRoom = null;
    let myName = null;
    let isHost = false;

    function goCreate(){ show("stepCreate"); }
    function goJoin(){ 
      show("stepRoomList"); 
      loadRoomList();
      supabase.channel("rooms-list")
        .on("postgres_changes",{event:"*",schema:"public",table:"avalon_rooms"},()=>loadRoomList())
        .subscribe();
    }
    function goBack(){ show("step1"); }
    function goChangeName(){ show("stepChangeName"); }
    function backToRoom(){ show("room"); }
    function show(id){
      ["step1","stepCreate","stepRoomList","room","stepChangeName"].forEach(s=>document.getElementById(s).style.display="none");
      document.getElementById(id).style.display="block";
    }

    function switchToRoom(roomCode){
      show("room");
      document.getElementById("roomCodeDisplay").innerText = roomCode;
    }

    function showMessage(text, color="hsl(135,25%,45%)"){
      const msg = document.getElementById("message");
      msg.innerText = text;
      msg.style.color = color;
      setTimeout(()=>{ msg.innerText=""; }, 3000);
    }

    async function getNextRoomCode(){
      const { data } = await supabase
        .from("avalon_rooms")
        .select("room_code")
        .order("room_code",{ascending:false})
        .limit(1);
      if(data && data.length>0){
        let last = parseInt(data[0].room_code,10);
        return String(last+1).padStart(3,"0");
      }else{
        return "001";
      }
    }

    async function createRoom(){
      myName = document.getElementById("hostName").value.trim();
      if(!myName){ showMessage("请输入昵称","hsl(3,40%,55%)"); return; }

      const roomCode = await getNextRoomCode();
      currentRoom = roomCode;
      isHost = true;

      const { error } = await supabase.from("avalon_rooms").insert([{
        room_code: roomCode,
        player_name: myName,
        role: null,
        is_host: true
      }]);
      if(error){ showMessage("创建失败: "+error.message,"hsl(3,40%,55%)"); return; }

      switchToRoom(roomCode);
      listenRoom(roomCode);
      showMessage("房间创建成功！");
    }

    async function loadRoomList(){
      const { data, error } = await supabase
        .from("avalon_rooms")
        .select("room_code, is_host")
        .order("room_code",{ascending:true});

      const list = document.getElementById("roomList");
      list.innerHTML = "";

      if(error){
        list.innerHTML = "<li>加载失败："+error.message+"</li>";
        return;
      }
      if(!data || data.length===0){
        list.innerHTML = "<li>暂无房间</li>";
        return;
      }

      const roomMap = {};
      data.forEach(r=>{
        if(!roomMap[r.room_code]) roomMap[r.room_code] = { count:0, hasHost:false };
        roomMap[r.room_code].count++;
        if(r.is_host) roomMap[r.room_code].hasHost = true;
      });

      Object.entries(roomMap).forEach(([code, info])=>{
        if(!info.hasHost) return;
        const li = document.createElement("li");
        li.style.margin = "8px 0";
        li.innerHTML = `
          <b>房间 ${code}</b> (${info.count}人)
          <button class="btn-secondary" style="width:auto;padding:6px 10px;font-size:14px;margin-left:10px;" onclick="promptJoin('${code}')">加入</button>
        `;
        list.appendChild(li);
      });

      if(list.innerHTML==="") list.innerHTML="<li>暂无可加入的房间</li>";
    }

    function promptJoin(code){
      const nickname = prompt("请输入你的昵称：");
      if(!nickname) return;
      joinRoomByCode(code, nickname);
    }

    async function joinRoomByCode(code, nickname){
      currentRoom = code;
      myName = nickname;

      const { data: check, error: checkError } = await supabase
        .from("avalon_rooms")
        .select("id, player_name, is_host")
        .eq("room_code", currentRoom);

      if(checkError){
        showMessage("加入失败: "+checkError.message,"hsl(3,40%,55%)");
        return;
      }
      if(!check || check.length===0){
        showMessage("房间不存在","hsl(3,40%,55%)");
        return;
      }
      if(!check.some(p => p.is_host)){
        showMessage("房间无效：未找到房主","hsl(3,40%,55%)");
        return;
      }
      if(check.some(p => p.player_name === myName)){
        showMessage("该昵称已在房间中","hsl(3,40%,55%)");
        return;
      }

      const { error } = await supabase.from("avalon_rooms").insert([{
        room_code: currentRoom,
        player_name: myName,
        role: null,
        is_host: false
      }]);
      if(error){ 
        showMessage("加入失败: "+error.message,"hsl(3,40%,55%)"); 
        return; 
      }

      isHost = false;
      switchToRoom(currentRoom);
      listenRoom(currentRoom);
      showMessage("加入房间成功！");
    }

    async function leaveRoom(){
      if(isHost){
        await supabase.from("avalon_rooms").delete().eq("room_code", currentRoom);
        showMessage("房间已解散！");
      }else{
        await supabase.from("avalon_rooms").delete()
          .eq("room_code", currentRoom)
          .eq("player_name", myName);
        showMessage("已退出房间！");
      }
      currentRoom=null; myName=null; isHost=false;
      show("step1");
      document.getElementById("playerList").innerHTML="";
      document.getElementById("myRole").innerText="我的身份：未分配";
    }

    function listenRoom(roomCode){
      supabase.channel("room-"+roomCode)
        .on("postgres_changes",{event:"*",schema:"public",table:"avalon_rooms"},()=>refreshPlayers(roomCode))
        .subscribe();
      refreshPlayers(roomCode);
    }

    function getRoleInfo(myRole, allPlayers){
      let info = [];
      if(myRole === "梅林"){
        info = allPlayers.filter(p => ["刺客","莫甘娜","爪牙","奥伯伦"].includes(p.role)).map(p=>p.player_name);
      }
      else if(myRole === "派西维尔"){
        info = allPlayers.filter(p => ["梅林","莫甘娜"].includes(p.role)).map(p=>p.player_name);
      }
      else if(["刺客","莫甘娜","爪牙","莫德雷德"].includes(myRole)){
        info = allPlayers.filter(p => ["刺客","莫甘娜","爪牙","莫德雷德"].includes(p.role)).map(p=>p.player_name);
      }
      else if(myRole === "野性仙子"){
        info = allPlayers.filter(p => ["派西维尔","奥伯伦","刺客"].includes(p.role)).map(p=>p.player_name);
      }
      else if(myRole === "奥伯伦" || myRole === "学徒"){
        info = [];
      }
      return info;
    }

    async function refreshPlayers(roomCode){
      const { data } = await supabase.from("avalon_rooms").select("id, player_name, role, is_host").eq("room_code", roomCode);
      const list=document.getElementById("playerList"); list.innerHTML="";
      if(data) data.forEach(p=>{
        const li=document.createElement("li");
        li.innerText = p.player_name + (p.is_host ? " 👑房主" : "");
        if(p.player_name===myName) li.classList.add("me");

        if(isHost && !p.is_host){
          const kickBtn = document.createElement("button");
          kickBtn.innerText = "❌";
          kickBtn.className = "kickBtn";
          kickBtn.onclick = async () => {
            await supabase.from("avalon_rooms").delete().eq("id", p.id);
            showMessage("已踢出玩家："+p.player_name);
          };
          li.appendChild(kickBtn);
        }

        list.appendChild(li);

        if(p.player_name===myName && p.role){
          let text = "我的身份：" + p.role;
          const info = getRoleInfo(p.role, data);
          if(info.length > 0){
            text += "\n我能看到：" + info.join("、");
          }
          document.getElementById("myRole").innerText = text;
        }
      });
      document.getElementById("roomCount").innerText = "当前人数：" + (data?data.length:0) + " 人";
    }

    async function assignRoles(){
      if(!isHost){ showMessage("只有房主可以分配身份","hsl(3,40%,55%)"); return; }
      const { data: players } = await supabase.from("avalon_rooms").select("*").eq("room_code", currentRoom);
      if(!players||players.length===0){ showMessage("没有玩家","hsl(3,40%,55%)"); return; }

      let rolesPool = [];
      if(players.length === 12){
        rolesPool = ["梅林","派西维尔","刺客","莫甘娜","奥伯伦","忠臣","忠臣","爪牙","莫德雷德","野性仙子","学徒"];
      } 
      else if(players.length === 11){
        rolesPool = ["梅林","派西维尔","刺客","莫甘娜","奥伯伦","忠臣","忠臣","爪牙","莫德雷德","野性仙子"];
      } 
      else {
        rolesPool = ["梅林","派西维尔","刺客","莫甘娜","奥伯伦","忠臣","忠臣","爪牙"];
      }

      let shuffled = rolesPool.slice(0,players.length).sort(()=>Math.random()-0.5);
      for(let i=0;i<players.length;i++){
        await supabase.from("avalon_rooms").update({role:shuffled[i]}).eq("id",players[i].id);
      }
      showMessage("身份分配完成！");
    }

    async function changeName(){
      const newName = document.getElementById("newNameInput").value.trim();
      if(!newName){ showMessage("请输入新昵称","hsl(3,40%,55%)"); return; }

      const { error } = await supabase
        .from("avalon_rooms")
        .update({ player_name: newName })
        .eq("room_code", currentRoom)
        .eq("player_name", myName);

      if(error){
        showMessage("修改失败: "+error.message,"hsl(3,40%,55%)");
        return;
      }

      myName = newName;
      document.getElementById("newNameInput").value = "";
      refreshPlayers(currentRoom);
      show("room");
      showMessage("昵称修改成功！");
    }
  </script>
</body>
</html>
